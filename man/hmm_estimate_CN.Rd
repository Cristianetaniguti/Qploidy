% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/hmm_main.R
\name{hmm_estimate_CN}
\alias{hmm_estimate_CN}
\title{Polyploid copy-number HMM (z + BAF) per sample and window}
\usage{
hmm_estimate_CN(
  qploidy_standarize_result,
  sample_id,
  snps_per_window = 500,
  min_snps_per_window = 100,
  cn_grid = 2:8,
  M = 121,
  bw = 0.03,
  max_iter = 60,
  z_only = FALSE
)
}
\arguments{
\item{sample_id}{Character scalar. Sample identifier to analyze; rows are
filtered as \code{df[[cols$sample]] == sample_id}.}

\item{snps_per_window}{Integer. Number of SNPs per window when
\code{cols$window} is \code{NULL}. Default \code{500}.}

\item{min_snps_per_window}{Integer. Minimum SNPs required to keep a window
(windows with fewer SNPs are dropped). Default \code{100}.}

\item{cn_grid}{Integer vector of copy-number states to consider (e.g., \code{2:8}).}

\item{M}{Integer. Number of BAF histogram bins on \eqn{[0,1]}. Default \code{121}.}

\item{bw}{Numeric. Bandwidth (SD) of the Gaussian kernels used to generate
the BAF comb templates. Default \code{0.03}.}

\item{max_iter}{Integer. Maximum EM iterations. Default \code{60}.}

\item{z_only}{Logical. If \code{TRUE}, fit the HMM using the z-emission only
(useful for debugging). Default \code{FALSE}.}

\item{df}{A SNP-level \code{data.frame} containing, at minimum, the columns
named in \code{cols}. One row per variant/SNP.}

\item{cols}{A named list giving the column names in \code{df}:
\describe{
  \item{\code{chr}}{Chromosome/contig name (default \code{"Chr"}).}
  \item{\code{pos}}{Genomic position (integer/numeric; default \code{"Position"}).}
  \item{\code{sample}}{Sample column (default \code{"SampleName"}).}
  \item{\code{baf}}{B-allele frequency in \eqn{[0,1]} (default \code{"baf"}).}
  \item{\code{z}}{Depth/coverage signal (already GC/mappability corrected),
        used as a Gaussian emission (default \code{"z"}).}
  \item{\code{window}}{Optional window ID column. If \code{NULL} (default),
        windows are created as equal-SNP bins within each chromosome.}
}}
}
\value{
A \code{data.frame} with one row per window and columns:
\itemize{
  \item \code{Sample}, \code{Chr}, \code{WindowID}, \code{Start}, \code{End}
  \item \code{n_snps}, \code{n_het} – counts per window
  \item \code{z} – mean z per window
  \item \code{w_baf} – weight applied to the BAF emission (0–1)
  \item \code{CN_call} – Viterbi copy-number call (factor/integer)
  \item \code{post_max} – posterior probability of the called state
  \item \code{post_CN<k>} – posterior probability for each state in \code{cn_grid}
}
The returned object also carries an attribute \code{"params"} with a list of
fitted HMM parameters: \code{cn_grid}, \code{mu} (z means), \code{sigma},
\code{A} (transition matrix), \code{pi0} (initial probs), \code{bins} (\code{M}),
\code{bw}, and the final \code{loglik}.
}
\description{
Aggregates SNP-level data into windows, builds BAF histograms, and fits a
Hidden Markov Model that combines a Gaussian emission for depth/z and a
polyploid BAF “comb” emission to infer copy number (CN) per window.
Returns a tidy data frame with CN calls and posterior probabilities that is
ready for plotting (e.g., with \code{\link{plot_cn_track}}) or merging across
chromosomes/batches.
}
\details{
\strong{Windowing.} If \code{cols$window} is not provided, windows are formed
within each chromosome by grouping every \code{snps_per_window} consecutive
SNPs. Windows with fewer than \code{min_snps_per_window} SNPs are removed.

\strong{Emissions.} For state \code{c} (copy number), the z-emission is
\eqn{\mathcal{N}(\mu_c, \sigma^2)}. The BAF emission is a multinomial
log-likelihood comparing the observed BAF histogram to a state-specific
template (a “comb” with peaks at \eqn{d/c}). Windows with few heterozygotes
are down-weighted via \code{w_baf} (derived from \code{n_het}).

\strong{Numerical safety.} The implementation guards against non-finite
emissions, enforces stochastic \code{A} rows, and lower-bounds \code{sigma}.
}
\section{Required helpers}{

This function calls \code{\link{baf_template}}, \code{\link{baf_ll}},
\code{\link{logsumexp}}, and \code{\link{viterbi}} which must be available in
your package/namespace.
}

\examples{
\dontrun{
# Suppose snp_df has columns: SampleName, Chr, Position, baf, z
res <- polyploid_cn_hmm(
  df = snp_df,
  sample_id = "ASample",
  cols = list(chr="Chr", pos="Position", sample="SampleName",
              baf="baf", z="z", window=NULL),
  snps_per_window = 500,
  cn_grid = 2:6
)
head(res)
attr(res, "params")
}

}
\seealso{
\code{\link{baf_template}}, \code{\link{baf_ll}},
  \code{\link{viterbi}}, \code{\link{plot_cn_track}}
}
